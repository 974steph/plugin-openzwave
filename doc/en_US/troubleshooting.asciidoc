== Fixing and diagnostic

=== My module is not detected or does not communicate its product identifiers and type 
image:../images/troubleshooting01.png[]

Request the regeneration of the node from the Actions tab of the module.

If you have several modules in this situation, request the "Regeneration of unknown nodes" from the Actions tab of the "Z-Wave network" screen.

=== My module is presumed Dead by the controller
image:../images/troubleshooting02.png[]

If the module is still powered and joinable, follow the proposed solutions in the module's screen.

If a module was decommissioned or is really faulty, you can excluded it from the network using "Delete the faulty node" from the *Actions* tab.

If a module was removed and sent to get repaired and a new one was received, you can request *Replace a faulty node* from the *Actions* tab ; the controller goes in inclusion mode and you can proceed with the new module's inclusion. 
The id of the device will remain the same, as well as its commands.


=== How to use the SwitchAll command
image:../images/troubleshooting03.png[]

It is available on your controller node.
Your controller should have the commands Switch All On and Switch All Off.

If the controller does not appear in the list of the nodes, launch a synchronization.

image:../images/troubleshooting04.png[]

The Switch All command class is generally supported on switches and dimmers. Its behavior can be configured on each module that supports it.

One can either :

** Deactivate the Switch All command class.
** Activate it for the On and the Off.
** Activate On only.
** Activate Off only.

The choice of options depends on the manufacturer.

You have to carefully study all switches and dimmers before setting up a scenario, if these modules are not only used for lights.


=== My module has no Scene or Button command
image:../images/troubleshooting05.png[]

You can add the command in the command "mapping" screen.

It is an *Info* command CC *0x2b* Instance *0* command *data{0}.val*

The Scene mode has to be activated in the parameters of the module. Refer to the documentation of the module for details.


=== Force refresh of the values

It is possible to request the refresh of the values of an instance for a specific command class. 

One can do it using an http request or by creating a command on the command mapping screen of a device.

image:../images/troubleshooting06.png[]

Create an *Action* command, select the wanted CC for a given *instance* with a command *data[0].ForceRefresh()*

The whole set of indexes of the instance for this command will be updated. The battery-powered nodes will refresh their values at their next wake-up.

You can also request it by script with an http request to the Z-Wave REST server.

Replace ip_jeedom, node_id, instance_id, cc_id and index in

\http://token:#APIKEY#@ip_jeedom:8083/ZWaveAPI/Run/devices[node_id].instances[instance_id].commandClasses[cc_id].data[index].ForceRefresh()

The access to the REST API having changed, refer to link:./restapi.asciidoc[içi].

=== Transfer the modules on a new controller
You might for several reasons need to transfer all your modules on a new primary controller.

For instance, you decide to replace a *raZberry* by a *Z-Stick Gen5*, or you need to reset the primary controller.

Here are the steps to follow so as to not lose your scenarios, widgets and values histories :

** 1) Backup Jeedom
** 2) Note (print screen) your parameters values for each module, as they will be lost after exclusion.
** 3) In the Z-Wave configuration unset the option "Automatically delete excluded devices" and save. The network restart.
** 4a) In the case of a *Reset*, reset the primary controller and restart the plugin.
** 4b) for a new controller, stop Jeedom, unplug the current controller and plug the new one in. Start the network.
** 5) for each Z-Wave device, set its Z-Wave ID to *0*.
** 6) Open 2 pages of the Z-Wave plugin in 2 different pages.
** 7) (from the first screen) fo on the configuration screen of a module to be included in the new controller.
** 8) (from the second screen) exclude then include the module. A new device will be created.
** 9) copy the Z-Wave ID of the new device, then delete it.
** 10) on the first screen set the Z-wave ID to the one that was copied.
** 11) The Z-Wave parameters are lost during exclusion/inclusion, so reset them to your specific values.
** 11) repeat steps 7 to 11 for each module to transfer.
** 12) when done you should have no devices left with Z-Wave ID 0.
** 13) verify all modules are present in the Z-Wave Health screen. If not, launch a synchronization.


=== Replacement of a faulty module
How to re-include a faulty module without losing your scenarios, widgets and its values history

If the module is presumed "Dead" :

** Note (print screen) its parameters values, as they will be lost after exclusion.
** Go to Actions tab of the module and launch the "Replace faulty mode" command.
** The controller is in inclusion mode, proceed with the module's inclusion.
** Reset your specific parameters.

Si le module n'est pas présumé "Dead" mais est toujours accessible:

** Dans la configuration ZWave décocher l'option "Supprimer automatiquement les périphériques exclus".
** Note (print screen) its parameters values, as they will be lost after exclusion.
** Exclure le module défaillant.
** Aller sur la page de configuration du module défaillant.
** Ouvrir la page du plugin ZWave dans un nouvel onglet.
** Faire l'inclusion du module.
** Copier l'ID du nouveau module, puis supprimer cet équipement.
** Retourner sur l'onglet de l'ancien module puis coller le nouvel ID à la place de l'ancien ID.
** Reset your specific parameters.


=== Suppression de noeud fantome
Si vous avez perdu toute communication avec un module sur pile et que vous souhaitez l'exclure du réseau, il est possible que l'exclusion n’aboutisse pas ou que le nœud reste présent dans votre réseau.

Un assistant automatique de nœud fantôme est disponible.

** Allez sur l'onglet actions du module à supprimer.
** Il aura probablement un statu *CacheLoad*.
** Lancer la commande *Supprimer nœud fantôme*.
** Le réseau Z-Wave s'arrête. L'assistant automatique modifie le fichier *zwcfg* pour supprimer la CC WakeUp du module. Le réseau redémarre.
** Fermer l'écran du module.
** Ouvrir l'écran de Santé Z-Wave.
** Attendre que le cycle de démarrage soit complété (topology loaded).
** Le module sera normalement marqué comme étant présumé mort (Dead).
** La minute suivante vous devriez voir le nœud disparaître de l'écran de santé.
** Si dans la configuration Z-Wave vous avez décoché l'option "Supprimer automatiquement les périphériques exclus", il vous faudra supprimer manuellement l'équipement correspondant.

Cette assistant est disponible seulement pour les modules sur piles.



=== Actions post inclusion

On recommande d'effectuer l'inclusion à moins 1M du contrôleur principal, or ce ne sera pas la position finale de votre nouveau module.
Voici quelques bonnes pratiques à faire suite à l’inclusion d'un nouveau module dans votre réseau.

Une fois l'inclusion terminée, il faut appliquer un certain nombre de paramètres à notre nouveau module afin d'en tirer le maximum. Rappel, les modules suite à l'inclusion ont les paramètres par défaut du constructeur.
Profiter d'être à côté du contrôleur et de l'interface Jeedom pour bien paramétrer votre nouveau module. Il sera aussi plus simple de réveiller le module pour voir l'effet immédiat du changement.
Certains modules ont une documentation spécifique Jeedom afin de vous aider avec les différents paramètres ainsi que des valeurs recommandées.

Tester votre module, valider les remontées d'informations, retour d'état et actions possibles dans le cas d'un actuateur.

Lors de l'interview votre nouveau module a recherché ses voisins. Toutefois les modules de votre réseau ne connaissent pas encore votre nouveau module.

Déplacer votre module à son emplacement définitif. Lancer la mise à jour de ces voisins et réveiller-le encore une fois.

image:../images/troubleshooting07.png[]

On constate qu'il voit un certain nombre de voisins mais que les voisin, eux, ne le voient pas.

Pour remédier à cette situation il faut lancer l'action soigner le réseau, afin de demander à tous les modules de retrouver leurs voisins.

Cette action peut prendre 24 heures avant d'être terminée, vos modules sur pile effectueront l'action seulement à leur prochain réveil.

image:../images/troubleshooting08.png[]

L'option de soigner le réseau 2x par semaine permet de faire ce processus sans action de votre part, elle est utile lors de la mise en place de nouveaux modules et ou lorsqu'on les déplace.


=== Pas de remontee etat de la pile

Les modules Z-Wave n'envoie que très rarement l'état de leurs piles au contrôleur.
Certains vont le faire à l'inclusion puis seulement lorsque celle-ci atteint 20% ou une autre valeur de seuil critique.

Pour vous aider à mieux suivre l'état de vos piles l'écran Batteries sous le menu Analyse vous donne une vue d'ensemble de l'état de vos piles.
Un mécanisme de notification de piles faibles est aussi disponible.

La valeur remontée de l'écran Piles est la dernière connue dans le cache.

Toutes les nuits, le plugin Z-Wave demande à chaque module de rafraichir la valeur Battery. Au prochain réveil, le module envoie la valeur à Jeedom pour être ajouté au cache.
Donc il faut en général attendre au moins 24h avant l'obtention d'une valeur dans l'écran Batteries.

[TIP]
Il est bien entendu possible de rafraichir manuellement la valeur Battery via l'onglet Valeurs du module puis, soit attendre le prochain réveil ou encore de réveiller manuellement le module pour obtenir une remontée immédiate.
Le cycle de réveil (Wake-up Interval) du module est défini dans l'onglet Système du module. Pour optimiser la vie de vos piles il est recommandé d'espacer au maximum ce délai. Pour 4h il faudrait appliquer 14400, 12h 43200.
Certains modules doivent écouter régulièrement des messages du contrôleur comme les Thermostats dans ce cas il faut penser à 15min  soit 900. Chaque module est différent il n'y a donc pas de règle exact c'est au cas par cas et selon l’expérience.

[TIP]
La décharge d'une pile n'est pas linéaire, certains modules vont montrer un grosse perte en pourcentage dans les premiers jours de mise en service, puis ne plus bouger durant des semaines pour se vider rapidement une fois passé les 20%.


=== Controleur est en cours d initialisation

Lorsque vous démarrez le démon Z-Wave, si vous essayez de lancer immédiatement une inclusion/exclusion vous risquez d'obtenir ce message:
* "Le contrôleur est en cours d'initialisation veuillez réessayer dans quelques minutes"

[TIP]
Suite au démarrage du démon, le contrôleur passe sur l'ensemble des modules afin de refaire leur interview. Ce comportement est tout-à-fait normal en OpenZWave.

Si toutefois après plusieurs minutes (plus de 10 minutes) vous avez toujours ce message ce n'est plus normal.

Il faut essayer les différentes étapes:

* S'assurer que les voyants de l'écran santé Jeedom soient au vert.
* S'assurer que la configuration du plugin est en ordre.
* S'assurer que vous avez bien sélectionné le bon port de la clé ZWave.
* S'assurer que votre configuration Réseau Jeedom est juste. (Attention si vous avez fait un Restore d’une installation DIY vers image officielle, le suffixe /jeedom ne doit pas y figurer)
* Regarder le log du plugin afin de voir si une erreur n'est pas remontée.
* Regarder la *Console* du plugin ZWave, afin de voir si une erreur n'est pas remontée.
* Lancer le Demon en *Debug* regarder à nouveau la *Console* et les logs du plugin.
* Redémarrer complètement Jeedom.
* Il faut s'assurer que vous avez bien un contrôleur Z-Wave, les Razberry sont souvent confondus avec les EnOcean (erreur lors de la commande).

Il faut maintenant débuter les tests hardwares:

* Le Razberry est bien branché au port GPIO.
* L'alimentation USB est suffisante.

Si le problème persiste toujours, il faut réinitialiser le contrôleur:

* Arrêter complément votre Jeedom via le menu d'arrêt dans le profil utilisateur.
* Débrancher l'alimentation.
* Retirer le dongle USB ou le Razberry selon le cas, environ 5 minutes.
* Re brancher le tout et essayer à nouveau.

=== Le controleur ne repond plus

Plus aucune commande n'est transmise aux modules mais les retours d'états sont remontés vers Jeedom.

Il est possible que la queue de messages du contrôleur soit remplie.
Voir l'écran Réseau Z-Wave si le nombre de messages en attente ne fait qu'augmenter.

Il faut dans ce cas relancer le Demon Z-Wave.

Si le problème persiste, il faut réinitialiser le contrôleur:

* Arrêter complément votre Jeedom via le menu d'arrêt dans le profil utilisateur.
* Débrancher l'alimentation.
* Retirer le dongle USB ou le Razberry selon le cas, environ 5 minutes.
* Re brancher le tout et essayer à nouveau.


=== Erreur lors des dependances

Plusieurs erreurs erreur peuvent survenir lors de la mise à jour des dépendances.
Il faut consulter le log de mise à jour des dépendances afin de déterminer quelle est exactement l'erreur.
De façon générale l'erreur se trouve à la fin du log dans les quelque dernières lignes.

Voici les possibles problèmes ainsi que leurs possibles résolutions:

* could not install mercurial – abort

Le package mercurial ne veut pas s'installer, pour corriger lancer en ssh:

 sudo rm /var/lib/dpkg/info/$mercurial* -f
 sudo apt-get install mercurial

* Les dépendances semblent bloquées sur 75%

A 75% c'est le début de la compilation de la librairie openzwave ainsi que du wrapper python openzwave.
Cette étape est très longue, on peut toutefois consulter la progression via la vue du log de mise à jour.
Il faut donc être simplement patient.


* Erreur lors de la compilation de la librairie openzwave

 arm-linux-gnueabihf-gcc: internal compiler error: Killed (program cc1plus)
 Please submit a full bug report,
 with preprocessed source if appropriate.
 See <file:///usr/share/doc/gcc-4.9/README.Bugs> for instructions.
 error: command 'arm-linux-gnueabihf-gcc' failed with exit status 4
 Makefile:266: recipe for target 'build' failed
 make: *** [build] Error 1

Cette erreur peut survenir suite à un manque de mémoire RAM durant la compilation.

Depuis l'UI jeedom, lancer la compilation des dépendances.

Une fois lancée, en ssh, arrêté ces processus (consommateurs en mémoire) :

 sudo systemctl stop cron
 sudo systemctl stop apache2
 sudo systemctl stop mysql

Pour suivre l'avancement de la compilation on fait un tail sur le fichier log openzwave_update.

 tail -f /var/www/html/log/openzwave_update

Lorsque la compilation est terminée et sans erreur, relancez  les services que vous avez arrêté

sudo systemctl start cron
sudo systemctl start apache2
sudo systemctl start mysql

[TIP]
Si vous etes toujours sous nginx il faudra remplacer *apache2* par *nginx* dans les commandes *stop* / *start*.
Le fichier log openzwave_update sera dans le dossier: /usr/share/nginx/www/jeedom/log .


=== Utilisation de la carte Razberry sur un Raspberry Pi 3

Pour utiliser un contrôleur Razberry sur un Raspberry Pi 3, le contrôleur Bluetooth interne du Raspberry doit être désactivé.


Ajouter cette ligne:

 dtoverlay=pi3-miniuart-bt

À la fin du fichier:

 /boot/config.txt

Puis redémarrer votre Raspberry.